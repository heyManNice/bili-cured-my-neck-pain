// ==UserScript==
// @name         B站治好了我的颈椎病
// @namespace    https://github.com/heyManNice/bili-cured-my-neck-pain
// @version      0.1.1
// @description  给B站PC网页版添加视频旋转功能，喜欢的话点点小星星哟~
// @author       https://github.com/heyManNice
// @match        https://www.bilibili.com/video/*
// @icon         https://heymannice.github.io/bili-cured-my-neck-pain/assets/bcmnp-logo.png
// @grant        GM_addStyle
// ==/UserScript==
GM_addStyle(`.bcmnp-rotate-box{box-sizing:border-box;position:absolute;width:fit-content;height:fit-content;flex-direction:column;font-size:12px;padding:10px 20px 12px;text-align:left;color:#fff;display:none;user-select:none}.bpx-player-ctrl-rotate:hover{animation:none!important}.bcmnp-rows{display:flex;flex-direction:column;gap:6px}.bcmnp-cols{display:flex;flex-direction:row;gap:8px}.bcmnp-rotate-item{background-color:#ffffff4d;border:none;border-radius:2px;width:50px;height:23px;line-height:23px;transition:background-color .3s ease}.bcmnp-rotate-item.checked{background-color:var(--bpx-primary-color, #00AEEC)}.bcmnp-rotate-item:not(.checked):hover{background-color:#fff6}.bcmnp-rotate-item:hover{cursor:pointer}
`);
(()=>{var L=Object.defineProperty;var k=(n,e,t)=>e in n?L(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>k(n,typeof e!="symbol"?e+"":e,t);var b=`<div class="bpx-player-ctrl-btn bpx-player-ctrl-rotate" role="button" aria-label="\u65CB\u8F6C">\r
    <!-- \u89C6\u9891\u65CB\u8F6C\u6309\u94AE -->\r
    <div class="bpx-player-ctrl-btn-icon">\r
        <span class="bpx-common-svg-icon">\r
            <svg style="scale: 0.97;" t="1765024556591" viewBox="0 0 1024 1024" version="1.1"\r
                xmlns="http://www.w3.org/2000/svg" width="200" height="200">\r
                <path id="bcmnp-toggle-icon-vertical"\r
                    d="m 553.81,128 c -35.34622,0 -84.48,49.13378 -84.48,84.48 v 256.85 h -1.52 v 0.96 h 87.82 l -2.74553,-0.96 V 211.54447 H 812.45553 V 682.67 H 768 l -0.03,-0.03 v 85.37 L 768,768 h 43.52 C 846.86622,768 896,718.86622 896,683.52 V 212.48 C 896,177.13378 846.86622,128 811.52,128 Z" />\r
                <path id="bcmnp-toggle-icon-shake"\r
                    d="m 336.896,128.98133 c 23.05754,-4.9956 56.03905,9.64648 61.03465,32.704 4.9956,23.05752 -15.89579,57.8246 -38.95333,62.8202 -34.38934,7.46667 -59.88399,22.96114 -85.18532,48.26247 -25.48613,25.59345 -43.25822,57.84048 -51.28533,93.056 l -1.19467,4.224 c -7.47494,21.29649 -40.48268,33.08736 -62.18918,26.90327 -21.70649,-6.18409 -34.8418,-38.44359 -29.97082,-60.48194 11.60528,-50.81938 37.27275,-97.34906 74.06933,-134.272 36.6134,-36.71308 83.01797,-62.11488 133.67467,-73.17333 z" />\r
                <path id="bcmnp-toggle-icon-dot"\r
                    d="m 361.13067,608.59733 c 11.78208,0 21.33333,9.55126 21.33333,21.33334 v 106.66666 c 0,11.78208 -9.55125,21.33334 -21.33333,21.33334 H 308.224 c -11.78208,0 -21.33333,-9.55126 -21.33333,-21.33334 V 629.93067 c 0,-11.78208 9.55125,-21.33334 21.33333,-21.33334 z" />\r
                <path id="bcmnp-toggle-icon-horizontal"\r
                    d="m 671.25789,470.38382 c 57.26015,1.19257 102.70476,58.84934 96.49376,114.6237 -0.22515,75.67856 0.96974,151.39574 -0.43437,227.04887 -8.43964,40.97159 -48.7707,65.94561 -85.28793,79.7445 -27.86729,8.38821 -57.60771,2.35022 -86.29846,4.15221 -128.93419,-0.27168 -257.91757,0.91802 -386.81976,-0.75429 -50.54449,-8.13703 -87.09271,-60.55525 -80.87974,-110.83244 0.60127,-79.60731 -1.45966,-159.34845 1.22674,-238.8684 10.18958,-50.6741 65.48009,-80.09982 114.32883,-76.17492 142.55783,-0.1735 285.11587,0.13346 427.67093,1.06077 z M 221.04821,802.95179 c 151.30119,0 302.60239,0 453.90358,0 0,-80.19008 0,-160.38016 0,-240.57024 -151.30119,0 -302.60239,0 -453.90358,0 0,80.19008 0,160.38016 0,240.57024 z" />\r
            </svg>\r
        </span>\r
    </div>\r
    <!-- \u89C6\u9891\u65CB\u8F6C\u63A7\u5236\u9762\u677F -->\r
    <div class="bcmnp-rotate-box bui-panel bui-dark">\r
        <div class="bcmnp-rows">\r
            <span>\u89C6\u9891\u65CB\u8F6C</span>\r
            <div class="bcmnp-cols bcmnp-rotate-items">\r
                <button data-angle="0" class="bcmnp-rotate-item checked">0\xB0</button>\r
                <button data-angle="90" class="bcmnp-rotate-item">90\xB0</button>\r
                <button data-angle="180" class="bcmnp-rotate-item">180\xB0</button>\r
                <button data-angle="270" class="bcmnp-rotate-item">270\xB0</button>\r
            </div>\r
        </div>\r
    </div>\r
</div>`;function f(n){return new Promise((e,t)=>{let i=0;function a(){let r=document.querySelector(n);if(r){e(r);return}if(i++>100){t(new Error(`Element ${n} not found after waiting.`));return}setTimeout(a,300)}a()})}function v(n,e){let o=document.createRange().createContextualFragment(e);n.parentElement?.insertBefore(o,n)}function m(n){console.log(`[B\u7AD9\u6CBB\u597D\u4E86\u6211\u7684\u9888\u690E\u75C5] ${n}`)}function y(n,e){console.log(`%c \u{1F92A} B\u7AD9\u6CBB\u597D\u4E86\u6211\u7684\u9888\u690E\u75C5 v${n} %c Cost ${e}ms`,"background:#4A90E2;color:white;padding:2px 6px;border-radius:3px 0 0 3px;font-weight:bold;","background:#50E3C2;color:#003333;padding:2px 6px;border-radius:0 3px 3px 0;font-weight:bold;")}function x(n,e,t){let o=[];for(let i of e)for(let a in i){let r=null;if(a==="@all"?r=n:r=n.querySelector(a),r){let s=o.find(c=>c.element===r);s||(s={element:r,keyframes:[]},o.push(s)),s.keyframes.push(i[a])}}for(let{element:i,keyframes:a}of o)i.animate(a,t)}var E=[{"@all":{scale:"1",translate:"0px 0px"},"#bcmnp-toggle-icon-dot":{opacity:"1"},"#bcmnp-toggle-icon-horizontal":{scale:"1",rotate:"0deg",transformOrigin:"50% 60%",translate:"0px 0px"},"#bcmnp-toggle-icon-vertical":{opacity:"1"},"#bcmnp-toggle-icon-shake":{opacity:"1",rotate:"0deg",transformOrigin:"50% 60%"}},{"@all":{scale:"1",translate:"-3px 0px"},"#bcmnp-toggle-icon-dot":{opacity:"0"},"#bcmnp-toggle-icon-horizontal":{scale:"1.1",rotate:"90deg",transformOrigin:"50% 60%",translate:"200px -50px"},"#bcmnp-toggle-icon-vertical":{opacity:"0"},"#bcmnp-toggle-icon-shake":{opacity:"0",rotate:"0deg",transformOrigin:"50% 60%"}},{"@all":{scale:"1",translate:"-3px 0px"},"#bcmnp-toggle-icon-dot":{opacity:"0"},"#bcmnp-toggle-icon-horizontal":{scale:"1.1",rotate:"90deg",transformOrigin:"50% 60%",translate:"200px -50px"},"#bcmnp-toggle-icon-vertical":{opacity:"0"},"#bcmnp-toggle-icon-shake":{opacity:"0",rotate:"180deg",transformOrigin:"50% 60%"}},{"@all":{scale:"1",translate:"0px 0px"},"#bcmnp-toggle-icon-dot":{opacity:"1"},"#bcmnp-toggle-icon-horizontal":{scale:"1",rotate:"0deg",transformOrigin:"50% 60%",translate:"0px 0px"},"#bcmnp-toggle-icon-vertical":{opacity:"1"},"#bcmnp-toggle-icon-shake":{opacity:"1",rotate:"0deg",transformOrigin:"50% 60%"}}];var h=class{constructor(){l(this,"toggle");l(this,"panel");l(this,"rotateItems");l(this,"timer",null);l(this,"isToggleAnimating",!1);let e=document.querySelector(".bpx-player-ctrl-rotate .bpx-player-ctrl-btn-icon"),t=document.querySelector(".bpx-player-ctrl-rotate .bcmnp-rotate-box"),o=document.querySelector(".bcmnp-rotate-items");if(!e||!t||!o)throw new Error("\u65CB\u8F6C\u6309\u94AE\u6216\u9762\u677F\u672A\u627E\u5230");this.toggle=e,this.panel=t,this.rotateItems=o,this.toggle.addEventListener("mouseenter",this.toggleOnMouseEnter.bind(this)),this.toggle.addEventListener("mouseleave",this.toggleOnMouseLeave.bind(this)),this.panel.addEventListener("mouseenter",this.panelOnMouseEnter.bind(this)),this.panel.addEventListener("mouseleave",this.panelOnMouseLeave.bind(this)),this.rotateItems.addEventListener("click",this.rotateItemOnClick.bind(this))}useTeimer(e,t=300){this.timer&&clearTimeout(this.timer),this.timer=window.setTimeout(()=>{e()},t)}showPanel(){this.panel.style.display!=="flex"&&(this.panel.style.display="flex",this.updatePanelPosition())}hidePanel(){this.panel.style.display!=="none"&&(this.panel.style.display="none")}toggleOnMouseEnter(e){this.isToggleAnimating||(this.isToggleAnimating=!0,x(this.toggle,E,{duration:800,easing:"ease"}),setTimeout(()=>{this.isToggleAnimating=!1},1500)),this.useTeimer(()=>{this.showPanel()})}toggleOnMouseLeave(e){this.useTeimer(()=>{this.hidePanel()})}panelOnMouseEnter(e){this.timer&&clearTimeout(this.timer)}panelOnMouseLeave(e){this.useTeimer(()=>{this.hidePanel()})}updatePanelPosition(){let e=this.toggle.getBoundingClientRect(),t=this.panel.getBoundingClientRect(),o=document.querySelector(".bpx-player-container")?.dataset.screen??"normal";o==="full"||o==="web"?this.panel.style.bottom="74px":this.panel.style.bottom="41px",this.panel.style.right=`${(e.width-t.width)/2}px`}rotateItemOnClick(e){let t=e.target;if(!t.classList.contains("bcmnp-rotate-item"))return;let o=t.dataset.angle;if(!o){m("\u672A\u627E\u5230\u65CB\u8F6C\u89D2\u5EA6\u6570\u636E");return}let i=parseInt(o,10);this.rotateVideo(i);let a=this.rotateItems.querySelector(".bcmnp-rotate-item.checked");a&&a.classList.remove("checked"),t.classList.add("checked")}rotateVideo(e){let t=document.querySelector(".bpx-player-video-wrap");if(!t){m("\u89C6\u9891\u5143\u7D20\u672A\u627E\u5230\uFF0C\u65E0\u6CD5\u65CB\u8F6C");return}let o=16,i=9,a=e*Math.PI/180,r=o/(o*Math.abs(Math.cos(a))+i*Math.abs(Math.sin(a))),s=i/(o*Math.abs(Math.sin(a))+i*Math.abs(Math.cos(a))),c=Math.min(r,s);(e===90||e===270||e===180)&&(c+=.01);let g=t.style.rotate||"0deg",w=t.style.scale||"1",p=`${e}deg`,u=`${c}`;t.style.rotate=p,t.style.scale=u;let d=g;g==="0deg"&&p==="270deg"?d="360deg":g==="270deg"&&p==="0deg"&&(d="-90deg"),t.animate([{rotate:d,scale:w},{rotate:p,scale:u}],{duration:300,easing:"ease-in-out"})}},M=null,T={onLoad:()=>{M?m("RotateController \u5DF2\u5B58\u5728\uFF0C\u8DF3\u8FC7\u521D\u59CB\u5316"):M=new h}};async function H(){let n=await f(".bpx-player-ctrl-btn.bpx-player-ctrl-pip"),e=performance.now();v(n,b),T.onLoad();let t=(performance.now()-e).toFixed(1);y("0.1.1",t)}H();})();
